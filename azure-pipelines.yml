# Azure DevOps Pipeline for Taskbook Frontend
trigger:
  branches:
    include:
      - main
  paths:
    exclude:
      - README.md

pr:
  branches:
    include:
      - main

pool:
  name: 'Default'

variables:
  - group: taskbook-secrets
  - name: azureServiceConnection
    value: 'azure-connection'
  - name: imageName
    value: 'taskbook-frontend'
  - name: containerAppName
    value: 'ca-taskbook-frontend'
  - name: resourceGroup
    value: 'rg-taskbook-dev'

stages:
  - stage: Build
    displayName: 'Build & Test'
    jobs:
      - job: BuildAndTest
        displayName: 'Build and Test'
        steps:
          - task: NodeTool@0
            displayName: 'Install Node.js'
            inputs:
              versionSpec: '20.x'

          - script: npm ci
            displayName: 'Install Dependencies'

          - script: npm run build
            displayName: 'Build Application'

  - stage: BuildImage
    displayName: 'Build Docker Image'
    dependsOn: Build
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - job: BuildPushImage
        displayName: 'Build and Push Docker Image'
        steps:
          - task: AzureCLI@2
            displayName: 'Get ACR Name and Backend URL'
            inputs:
              azureSubscription: $(azureServiceConnection)
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                ACR_NAME=$(az acr list --resource-group $(resourceGroup) --query "[0].name" -o tsv)
                echo "##vso[task.setvariable variable=acrLoginServer]${ACR_NAME}.azurecr.io"
                echo "##vso[task.setvariable variable=acrNameResolved]${ACR_NAME}"
                echo "ACR Name: ${ACR_NAME}"

                BACKEND_FQDN=$(az containerapp show \
                  --name ca-taskbook-backend \
                  --resource-group $(resourceGroup) \
                  --query "properties.configuration.ingress.fqdn" -o tsv)
                echo "##vso[task.setvariable variable=backendUrl]https://${BACKEND_FQDN}/api"
                echo "Backend URL: https://${BACKEND_FQDN}/api"

          - task: AzureCLI@2
            displayName: 'Build and Push to ACR'
            inputs:
              azureSubscription: $(azureServiceConnection)
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                az acr build \
                  --registry $(acrNameResolved) \
                  --image $(imageName):$(Build.BuildId) \
                  --image $(imageName):latest \
                  --build-arg VITE_API_BASE_URL=$(backendUrl) \
                  --file Dockerfile \
                  .

  - stage: Deploy
    displayName: 'Deploy to Container Apps'
    dependsOn: BuildImage
    condition: succeeded()
    jobs:
      - deployment: DeployToContainerApps
        displayName: 'Deploy to Container Apps'
        environment: 'dev'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: AzureCLI@2
                  displayName: 'Get ACR Name'
                  inputs:
                    azureSubscription: $(azureServiceConnection)
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      ACR_NAME=$(az acr list --resource-group $(resourceGroup) --query "[0].name" -o tsv)
                      echo "##vso[task.setvariable variable=acrLoginServer]${ACR_NAME}.azurecr.io"

                - task: AzureCLI@2
                  displayName: 'Deploy to Container App'
                  inputs:
                    azureSubscription: $(azureServiceConnection)
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      az containerapp update \
                        --name $(containerAppName) \
                        --resource-group $(resourceGroup) \
                        --image $(acrLoginServer)/$(imageName):$(Build.BuildId)

                - task: AzureCLI@2
                  displayName: 'Verify Deployment'
                  inputs:
                    azureSubscription: $(azureServiceConnection)
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      echo "Waiting for deployment to stabilize..."
                      sleep 30

                      # Get the FQDN
                      FQDN=$(az containerapp show \
                        --name $(containerAppName) \
                        --resource-group $(resourceGroup) \
                        --query "properties.configuration.ingress.fqdn" -o tsv)

                      echo "Frontend URL: https://${FQDN}"

                      # Health check
                      curl -f "https://${FQDN}" || echo "Warning: Health check returned non-zero"
